<#include "header.htm">
<script type="text/javascript" language="javascript" src="lib/area.js"></script>
<div class="main"> 
    <#include "appbar.htm">
    <div id="mainpart" class="mainpart">
    <div id="content">
        <h2 class="app_user">用户资料</h2>
        <div class="tabs">
            <ul class="menu">
              <li<#if type=="info"> class="active"</#if>><a href="userset.do" title="基本信息">基本信息</a></li>
              <li<#if type=="avatar" || type=="makeavatar"> class="active"</#if>><a href="userset.do?type=avatar" title="头像设置">头像设置</a></li>
              <li<#if type=="password"> class="active"</#if>><a href="userset.do?type=password" title="修改密码">修改密码</a></li>
            </ul>
        </div>
    <#if type=="info">
        <div class="rs_head">填写完整准确的个人资料，可以让更多的朋友找到您。</div>
                <form name="form" method="post" action="userset!saveInfo.do" onsubmit="changeValue();">
                    <table class="form_table" border="0">
                        <tr>
                            <th>姓名</th>
                            <td>${user.realname}</td>
                        </tr>
         
                        <tr>
                            <th>性别</th>
                            <td>						
                                <select id="sex" name="sex">
                                    <option value="1" <#if user.sex == 1 >selected="selected" </#if> >男</option>
                                    <option value="0" <#if user.sex == 0 >selected="selected" </#if> >女</option>
                                </select>
                            </td>
                        </tr>
         
                        <tr>
                            <th>生日</th>
                            <td>
                                
            <select id='birth_year' name='birth_year'>
                <option value=''>请选择</option><option value="1950">1950</option><option value="1951">1951</option><option value="1952">1952</option><option value="1953">1953</option><option value="1954">1954</option><option value="1955">1955</option><option value="1956">1956</option><option value="1957">1957</option><option value="1958">1958</option><option value="1959">1959</option><option value="1960">1960</option><option value="1961">1961</option><option value="1962">1962</option><option value="1963">1963</option><option value="1964">1964</option><option value="1965">1965</option><option value="1966">1966</option><option value="1967">1967</option><option value="1968">1968</option><option value="1969">1969</option><option value="1970">1970</option><option value="1971">1971</option><option value="1972">1972</option><option value="1973">1973</option><option value="1974">1974</option><option value="1975">1975</option><option value="1976">1976</option><option value="1977">1977</option><option value="1978">1978</option><option value="1979">1979</option><option value="1980">1980</option><option value="1981">1981</option><option value="1982">1982</option><option value="1983">1983</option><option value="1984">1984</option><option value="1985">1985</option><option value="1986">1986</option><option value="1987">1987</option><option value="1988">1988</option><option value="1989">1989</option><option value="1990">1990</option><option value="1991">1991</option><option value="1992">1992</option><option value="1993">1993</option><option value="1994">1994</option><option value="1995">1995</option><option value="1996">1996</option><option value="1997">1997</option><option value="1998">1998</option><option value="1999">1999</option><option value="2000">2000</option></select>年
            <select id='birth_month' name='birth_month'>
                <option value=''>--</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option></select>月
            <select id='birth_day' name='birth_day'>
                <option value=''>--</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option></select>日					</td>
                        </tr>
                        
                        <tr>
                            <th>家乡</th>
         
                            <td>
                                <div id="birth">
                                    <select name='s1' id="s1"><option>请选择</option></select>
                                    <input type='hidden' name='birth_province' id='birth_province' value='${user.birthProvince!}' />
                                    <select name='s2' id="s2" onchange="document.getElementById('birth_city').value=this.value;"><option>请选择</option></select>
                                    <input type='hidden' name='birth_city' id='birth_city' value='${user.birthCity!}' />
                                </div>
                            </td>
                        </tr>
         
                        <tr>
                            <th>居住地</th>
                            <td>
                                <div id="reside">
                                    <select name='r1' id="r1"><option>请选择</option></select>
                                    <input type='hidden' name='reside_province' id='reside_province' value='${user.resideProvince!}' />
                                    <select name='r2' id="r2"><option>请选择</option></select>
                                    <input type='hidden' name='reside_city' id='reside_city' value='${user.resideCity!}' /> 
                                </div>
                            </td>
                        </tr>
        
                        <tr>
                            <th>注册时间</th>
                            <td>${user.regtimeToDate?string("yyyy-MM-dd")!}</td>
                        </tr>
         
                        <tr>
                            <td></td>
                            <td>
                                <input type="submit" name="profilesubmit2" value="提交" class="regular-btn" />
                                <input type="reset" name="Submit" class="regular-btn" value="取消" />
                            </td>
                        </tr>
                    </table>
                </form>
                <script type="text/javascript">
                    var birthday = ${user.birthday?c};
                    if( birthday != 0)
                    {
                    document.getElementById('birth_year').value=parseInt(birthday/10000);
                    document.getElementById('birth_month').value=parseInt(birthday/100%100);
                    document.getElementById('birth_day').value=birthday%100;
                    }
        
                    //家乡
                    setup();
                    document.getElementById('s1').value='${user.birthProvince!}';
                    change(1);
                    document.getElementById('s2').value='${user.birthCity!}';
                    //居住地
                    setup2();
                    document.getElementById('r1').value='${user.resideProvince!}';
                    change2(1);
                    document.getElementById('r2').value='${user.resideCity!}';
                    
                    function changeValue(){
                        document.getElementById('birth_province').value=document.getElementById('s1').value;
                        document.getElementById('birth_city').value=document.getElementById('s2').value;
                        document.getElementById('reside_province').value=document.getElementById('r1').value;
                        document.getElementById('reside_city').value=document.getElementById('r2').value;
                        return true;
                    }
                </script>
        </div>
    </#if>
    
    <#if type=="password">
    <script type="text/javascript"> 
    // 检测原密码
    old_password = function(){
        var old_password = document.getElementById('old_pw');
        if(old_password.value=='') {
            parent.Dialog.alert('请填写原始密码！');
            old_password.focus();
            return false;
        }
        return true;
    };
    // 检测密码
    user_password = function(){
        var user_password = document.getElementById('new_pw');
        if(user_password.value=='') {
            parent.Dialog.alert('请填写新密码！');
            user_password.focus();
            return false;
        } else if(user_password.value.length<6 || user_password.value.length>16) {
            parent.Dialog.alert('新密码格式不正确！');
            user_password.focus();
            return false;
        }
        return true;
    };
     
    // 检测确认密码
    user_repassword = function(){
        var user_password = document.getElementById('new_pw');
        var user_repassword = document.getElementById('new_pw_repeat');
        if(user_repassword.value=='') {
            parent.Dialog.alert('请重复填写新码！');
            user_repassword.focus();
            return false;
        } else if(user_repassword.value!=user_password.value) {
            parent.Dialog.alert('两次密码输入不一致！');
            return false;
        }
        return true;
    };
     
    function check_form(){
        if(old_password() && user_password() && user_repassword()){
            return true;
        }else{
            return false;
        }
    }
    <#if fieldErrors.NewPswError?? && fieldErrors.NewPswError[0] == "true">
        parent.Dialog.alert('两次密码输入不一致！',function(){top.location="userset.do?type=password";});
    </#if>
    <#if fieldErrors.OldPswError?? && fieldErrors.OldPswError[0] == "true" !>
        parent.Dialog.alert('原密码错误！',function(){top.location="userset.do?type=password";});
    </#if>
    <#if fieldErrors.SavePswSuccess?? && fieldErrors.SavePswSuccess[0] == "true" !>
        parent.Dialog.alert('密码修改成功！',function(){top.location="userset.do?type=password";});
    </#if>
    </script>
        <form id="form1" name="form1" method="post" class="form_table" action="userset!savePassword.do" onsubmit="return check_form();" enctype="multipart/form-data">
        <table border="0" class='form_table'>
          <tr>
            <th width="18%">原始密码</th>
            <td width="82%"><input class="small-text2" type="password" name="old_pw" id="old_pw" value="" autocomplete="off" /></td>
          </tr>
          <tr>
            <th>新密码</th>
            <td><input class="small-text2" type="password" name="new_pw" id="new_pw" value="" /></td>
          </tr>
          <tr>
            <th>重复密码</th>
            <td><input class="small-text2" type="password" name="new_pw_repeat" id="new_pw_repeat" value="" /></td>
          </tr>
          <tr>
            <td></td>
            <td class="gray">由6-20个字符组成，使用常用密码以免遗忘。 </td>
          </tr>
          <tr>
            <td></td>
            <td><input type="submit" name="Submit" class="regular-btn" value="提交" /><input type="button" name="Submit2" class="regular-btn" onclick="location.href='modules.php?app=user_pw_change'" value="取消" /></td>
          </tr>
        </table>
        </form>
    </#if>
    <#if type=="avatar">
        <div class="rs_head">您可以设置漂亮个性化的头像，以便您的好友更好的认识您!</div>
        
        <table class='form_table' cellpadding="0" cellspacing="0">
            <tr>
                <th valign="top">当前头像：</th>
                <td><img id="user_ico" class="photo_frame" src=""></td>
            </tr>
        </table>
        
        <table class='form_table' id="normal_ico"  cellpadding="0" cellspacing="0">
            <tr>
                <td colspan=2>从本地上传图片后在线进行头像裁剪。</td>
            </tr>
            <tr>
                <td colspan=2>
                    <script type="text/javascript">
					window.onerror=function(){return true;}
                    document.getElementById('user_ico').src = "${avatarPath}big.jpg?vc="+rand_value;
                    
                    function LimitAttach(form, file) {
                        if (!file) 
                        {
                            parent.Dialog.alert('请选择上传的文件！');
                            return false;
                        }
                        while (file.indexOf("\\") != -1)
                        file = file.slice(file.indexOf("\\") + 1);
                        ext = file.slice(file.indexOf(".")).toLowerCase();
                        if ( ext == ".jpg" ||  ext == ".jpeg" )
                        {
                            form.submit();
                            return false;
                        }
                        else
                        {
                            parent.Dialog.alert('对不起，只能上传以下格式的文件:  .jpg  .jpeg <br>请重新选择符合条件的文件再上传。');
                            return false;
                        }
                    }
                    </script>            
                    <form name="form1" method="post" action="userset!avatarUpload.do" enctype="multipart/form-data" >
                        <input  class='left mr10' style="height:23px;" type="file" name="avatarFile" />
                        <input class='small-btn left' type="submit" name="submit" id="UploadButton" value="上传" onclick="LimitAttach(this.form, this.form.avatarFile.value);return false;"/>
                    </form>
                </td>
            </tr>
        </table>
    </#if>
    <#if type=="makeavatar">
    <#assign tempAvatar = Session["tempAvatar"]?default("")/> 
        <form name="form_ico_info" method="post" action="">
            <table class='form_table' style="clear:both" cellpadding="0" cellspacing="0">
                <tr>
                    <th>头像预览：</th>
                    <td>
                        <div id='msg'>
                            <img id="user_ico" src="${avatarPath}big.jpg" class="user_ico">
                        </div>
                    </td>
                </tr>
            </table>
                       
            <table width="500px" cellpadding="0" cellspacing="0" style="clear:both;margin-top:15px;margin-left:29px;">             
                <tr>
                    <td style="padding-top:10px;"><img src="spacer.gif" width=1 height=1></td>
                </tr>
                
                <tr>
                    <td style="width:100%">
                        <div id="wrapper">
                            <div id="cut_div" onDblClick="CutImageUtil.end_cut_image();" title="双击裁剪"></div>
                            <div style="padding-bottom:18px;">
                                <table border="0" width="500" cellspacing="2" cellpadding="2" id="table1">
                                    <tr>
                                        <td width="80"><b>图片剪裁:</b></td>
                                        <td id='zoom_in_l' width="26" onclick="zoom_in();" class='hand' align='right'><img id='zoom_in_m' src='skin/default/images/zoom_in.jpg'></td>
                                        <td id='zoom_in_r' width="30" onclick="zoom_in();" class='hand' align='left'>放大</td>
                                        <td id='zoom_out_l' width="26" onclick="zoom_out();" class='hand' align='right'><img id='zoom_out_m' src='skin/default/images/zoom_out.jpg'></td>
                                        <td id='zoom_out_r' width="60" onclick="zoom_out();" class='hand' align='left'>缩小</td>
                                        <td align="right">
                                            <input type='button' class="regular-btn" style="font-weight:normal" onclick="CutImageUtil.end_cut_image();" value='裁剪'>
                                        </td>
                                        <td>
                                            <input type='button' class="regular-btn" style="display:none; font-weight:normal" id="ico_action" onclick="javascript:saveAvatar();" value='设为头像'>
                                        </td>
                                        <td align="left" width="10">
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div style="float:left; margin:0 0 0 10px 10px; padding-left:0px;">
                                <div style="clear:both;border:1px #bbb solid; padding:2px;"><img id="cut_img" src="data/temp/${tempAvatar}" style="margin:0;padding:0;" /></div>
                            </div>
                        </div>
                        <div style="float:left; margin-left:40px;">
                            <div id="preview_div"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th></th>
                </tr>
            </table>
        </form>
    <style type="text/css"> 
    *{ margin:0; padding:0;}
    #wrapper{ clear:both;margin:10px; padding:0;}
    #cut_div{ height:200px!important; width:200px; border:1px dashed #eee; background:#000; filter:alpha(opacity=20); opacity: 0.2;}
    #preview_div{ height:200px; width:200px; border:1px solid #000; display:none;}
    .zoom_disable{
      filter: Gray;
    }
    </style>
    <script type="text/javascript" src="lib/img_cut/prototype.js"></script>
    <script type="text/javascript" src="lib/img_cut/drag.js"></script>
    <script type="text/javascript" src="lib/img_cut/cut_image.js"></script>
    <script type="text/javascript">
        if("${tempAvatar}" == "")
            top.location="userset.do?type=avatar";
        var CutImageUtil = new CutImageClass('cut_img' , 'cut_div' , 'preview_div');
        CutImageUtil.begin_cut_image();
        init_dom();//初始化对象函数
        
        function saveAvatar(){
            jQuery.post(
				"saveavatar.do",
				{ type: 'avatarSuccess',rv: rand_value},
				function(json){
					if(json.saveavatar){
						parent.Dialog.alert('头像修改成功！',function(){top.location="userset.do?type=avatar";});
					}else{
						parent.Dialog.alert('头像修改失败！');
					}
				},
				"json");	
        }
           
        function init_dom(){
            var CutImageUtil = new CutImageClass('cut_img' , 'cut_div' , 'preview_div');
            var timer;
            if(window.document.readyState==4){
                init_img();
                CutImageUtil.begin_cut_image();
                clearTimeout(timer);
            }else{
                timer=setTimeout('init_img(),CutImageUtil.begin_cut_image()',50);
            }
        }
      
        function init_img(){
            var max_width=500;//图片最大宽度
            var img_width=1024;
            var img_ojb=document.getElementById("cut_img");
            if(img_width>max_width){
                img_ojb.style.width=max_width+"px";
            }else{
                img_ojb.style.width=img_width+"px";
            }
        }
        
        function zoom_out(){
            var img_width=document.getElementById("cut_img").offsetWidth;
            var img_height=document.getElementById("cut_img").offsetHeight;
            var height_width=img_height/img_width;//高宽比
            var img_zoom_num=img_width*0.2;
            var img_ojb=document.getElementById("cut_img");
            var img_width_new=img_width-img_zoom_num;
            var img_height_new=height_width*img_width_new;
            if(img_width_new>200&&img_height_new>200){
              img_ojb.style.width=img_width_new+"px";
              zoom_in_enable();
            }else{
              zoom_out_disable();
            }
            CutImageUtil.begin_cut_image();
        }
        
        function zoom_in(){
            var max_width=530;//图片最大宽度
            var img_width=document.getElementById("cut_img").offsetWidth;
            var img_zoom_num=img_width*0.2;
            var img_ojb=document.getElementById("cut_img");
            var img_width_new=img_width+img_zoom_num;
            if(img_width_new<max_width){
                img_ojb.style.width=img_width_new+"px";
                zoom_out_enable();
            }else{
                zoom_in_disable();
            }
            
            CutImageUtil.begin_cut_image();
        }
        
        function zoom_out_disable(){
            $('zoom_out_m').src='skin/default/images/zoom_out_dis.jpg';
            $('zoom_out_l').className='';
            $('zoom_out_r').className='';
        }
        
        function zoom_out_enable(){
            $('zoom_out_m').src='skin/default/images/zoom_out.jpg';
            $('zoom_out_l').className='hand';
            $('zoom_out_r').className='hand';
        }
        
        function zoom_in_disable(){
            $('zoom_in_m').src='skin/default/images/zoom_in_dis.jpg';
            $('zoom_in_l').className='';
            $('zoom_in_r').className='';
        }
        
        function zoom_in_enable(){
            $('zoom_in_m').src='skin/default/images/zoom_in.jpg';
            $('zoom_in_l').className='hand';
            $('zoom_in_r').className='hand';
        }
    </script>
    
    </#if>
    
    </div>
    </div>
</div>
<div class="clear"></div>

<#include "footer.htm">
